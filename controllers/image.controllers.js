"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:!0}),exports.getImage=exports.uploadImage=exports.viewImage=void 0;var _regenerator=_interopRequireDefault(require("@babel/runtime/regenerator")),_asyncToGenerator2=_interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator")),_fs=_interopRequireDefault(require("fs")),_Image=_interopRequireDefault(require("../models/Image")),_logging=require("../config/logging"),_MoveFiles=_interopRequireDefault(require("../utils/MoveFiles"));function _createForOfIteratorHelper(a,b){var c="undefined"!=typeof Symbol&&a[Symbol.iterator]||a["@@iterator"];if(!c){if(Array.isArray(a)||(c=_unsupportedIterableToArray(a))||b&&a&&"number"==typeof a.length){c&&(a=c);var d=0,e=function(){};return{s:e,n:function n(){return d>=a.length?{done:!0}:{done:!1,value:a[d++]}},e:function e(a){throw a},f:e}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var f,g=!0,h=!1;return{s:function s(){c=c.call(a)},n:function n(){var a=c.next();return g=a.done,a},e:function e(a){h=!0,f=a},f:function f(){try{g||null==c["return"]||c["return"]()}finally{if(h)throw f}}}}function _unsupportedIterableToArray(a,b){if(a){if("string"==typeof a)return _arrayLikeToArray(a,b);var c=Object.prototype.toString.call(a).slice(8,-1);return"Object"===c&&a.constructor&&(c=a.constructor.name),"Map"===c||"Set"===c?Array.from(a):"Arguments"===c||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(c)?_arrayLikeToArray(a,b):void 0}}function _arrayLikeToArray(a,b){(null==b||b>a.length)&&(b=a.length);for(var c=0,d=Array(b);c<b;c++)d[c]=a[c];return d}var NAMESPACE="Images",viewImage=function(a,b){b.send("respond with a resource")};exports.viewImage=viewImage;var uploadImage=/*#__PURE__*/function(){var a=(0,_asyncToGenerator2["default"])(/*#__PURE__*/_regenerator["default"].mark(function a(b,c,d){var e,f,g,h,i,j,k,l;return _regenerator["default"].wrap(function(a){for(;;)switch(a.prev=a.next){case 0:if(b.files){a.next=2;break}return a.abrupt("return",c.status(400).json({success:!1,message:"No files were uploaded"}));case 2:e=__dirname+"../uploads/",_fs["default"].existsSync(e)||_fs["default"].mkdirSync(e),f=b.files.file,g=[".png",".jpg",".jpeg",".gif"],Array.isArray(f)||(f=[f]),a.prev=7,h=_createForOfIteratorHelper(f),a.prev=9,h.s();case 11:if((i=h.n()).done){a.next=28;break}return j=i.value,k=Date.now(),a.next=16,(0,_MoveFiles["default"])(j,e,k);case 16:return a.prev=16,a.next=19,_Image["default"].create({name:j.name,description:j.mimetype,estate:!0});case 19:l=a.sent,(0,_logging.info)(NAMESPACE,"Success image ".concat(j.name)),a.next=26;break;case 23:a.prev=23,a.t0=a["catch"](16),c.status(500).json({message:a.t0.message,err:a.t0});case 26:a.next=11;break;case 28:a.next=33;break;case 30:a.prev=30,a.t1=a["catch"](9),h.e(a.t1);case 33:return a.prev=33,h.f(),a.finish(33);case 36:a.next=43;break;case 38:if(a.prev=38,a.t2=a["catch"](7),!a.t2.code){a.next=42;break}return a.abrupt("return",d(a.t2));case 42:return a.abrupt("return",c.status(400).json({success:!1,message:a.t2.message,path:e}));case 43:c.status(201).json({success:!0,message:"Files successfully uploaded",path:e});case 44:case"end":return a.stop();}},a,null,[[7,38],[9,30,33,36],[16,23]])}));return function(){return a.apply(this,arguments)}}();exports.uploadImage=uploadImage;var getImage=/*#__PURE__*/function(){var a=(0,_asyncToGenerator2["default"])(/*#__PURE__*/_regenerator["default"].mark(function a(b,c){var d,e;return _regenerator["default"].wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.prev=0,d=b.params.id,a.next=4,_Image["default"].findOne({_id:d});case 4:e=a.sent,c.status(200).json(e),a.next=11;break;case 8:a.prev=8,a.t0=a["catch"](0),c.status(500).json({message:a.t0.message,err:a.t0});case 11:case"end":return a.stop();}},a,null,[[0,8]])}));return function(){return a.apply(this,arguments)}}();exports.getImage=getImage;